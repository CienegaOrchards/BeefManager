<!DOCTYPE html>
<html>
  <head>
    <% include include/jquery-header.ejs %>
    <% include include/cienegacss.ejs %>
    <% var moment = require('moment'); %>
    <title>Inventory</title>
  </head>
  <body>
    <% if(user !== undefined && user) { %>
    <button id='logout'>Log Out <%= user.get('realname') %></button></form>
    <% } %>
    <table summary="Prices of meats">
        <thead><tr><th>Species</th><th>Category</th><th>Cut</th><th>Qty</th><th>Price</th><th>Location</th><th>Freezer</th><th>Slaughtered</th></tr></thead></thead>
        <tbody>
            <%
                var prev_species='', prev_cat = '', prev_cut = '';
                meats.forEach(function(meat) {
                    var cut = meat.get('cut');
                    var freezer = meat.get('freezer');
                    var animal = meat.get('animal');
            %>
            <tr>
            <td><% if(cut.get('species') != prev_species) { prev_species = cut.get('species') %><%= prev_species %><% } %></td>
            <td><% if(cut.get('category') != prev_cat) { prev_cat = cut.get('category') %><%= prev_cat === undefined ? '' : prev_cat %><% } %></td>
            <td><% if(cut.get('cut') != prev_cut) { prev_cut = cut.get('cut') %><%= prev_cut === undefined ? '' : prev_cut %><% } %></td>
            <td><span class='aligndecimals'><%= meat.get('units').toFixed(2) %></span><span style='float:right;'>&nbsp;<%= cut.get('units') %></span></td>
            <td><span style='float:left;'>$</span> <span class='aligndecimals'><%= (meat.get('units') * cut.get('price')).toFixed(2) %></span></td>
            <td><span class='location'><%= freezer.get('location') %></span></td>
            <td><%= freezer.get('identifier') %></td>
            <td><%= animal === undefined ? '' : moment(animal.get('slaughtered')).fromNow() %></td>
            </tr>
            <% }) %>
        </tbody>
    </table>

    <% include include/jquery-scripts.ejs %>

    <script>
        $(document).ready(function() {
            // Align decimal points
            $('.aligndecimals').each(function()
            {
                var wholePart, fractionPart;
                var parts = $(this).text().split('.');
                wholePart = parts.shift();
                fractionPart = parts.shift();
                var html = '<span style="float:left;text-align:right;width:3em;">' + wholePart + '.</span>';
                html += '<span style="text-align:left;">' + fractionPart + '</span>';
                $(this).html(html);
            });

            // Colorize locations
            $('.location').each(function()
            {
                if($(this).text() == '91 Mt Vernon')
                {
                    $(this).addClass('mtvernon');
                }
                else if($(this).text() == 'Cienega Barn')
                {
                    $(this).addClass('cienegabarn');
                }
            });

            $('#logout').button().click(function(event)
            {
                event.preventDefault();
                window.location.href = '/logout';
            });
        });
    </script>
  </body>
</html>
